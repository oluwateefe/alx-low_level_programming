nested loop and more functions

